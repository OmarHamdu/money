<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¹Ù…Ø± Ø§Ù„Ù…Ø§Ù„ÙŠ (Ø§Ù„Ù…Ø·ÙˆØ±)</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #64748b;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --gold: #d97706;
            --bg: #f1f5f9;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --radius: 16px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        body.dark-mode {
            --bg: #0f172a;
            --card-bg: #1e293b;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border: #334155;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            display: flex;
            min-height: 100vh;
            transition: background-color 0.3s;
        }

        /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
        .sidebar {
            width: 260px;
            background: #1e293b;
            color: white;
            padding: 20px;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            box-sizing: border-box;
            z-index: 1000;
        }

        .sidebar h2 {
            text-align: center;
            font-weight: 800;
            margin-bottom: 30px;
            color: #60a5fa;
            border-bottom: 2px solid #334155;
            padding-bottom: 15px;
        }

        .nav-btn {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 8px;
            background: transparent;
            border: none;
            color: #cbd5e1;
            font-family: inherit;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.2s;
        }

        .nav-btn:hover, .nav-btn.active {
            background: #334155;
            color: white;
            transform: translateX(-5px);
        }

        .nav-btn span { margin-left: 12px; font-size: 1.3rem; }

        /* Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
        .main-content {
            flex: 1;
            margin-right: 260px;
            padding: 30px;
            width: calc(100% - 260px);
        }

        .page { display: none; animation: fadeIn 0.4s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h1 { margin-bottom: 25px; font-weight: 800; color: var(--text-main); }

        /* Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--card-bg);
            padding: 25px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
            transition: transform 0.2s;
        }

        .card:hover { transform: translateY(-3px); }

        .card h3 { margin: 0 0 10px 0; font-size: 1rem; color: var(--text-muted); font-weight: 600; }
        .card .amount { font-size: 2rem; font-weight: 800; color: var(--text-main); }
        .card small { display: block; margin-top: 5px; font-size: 0.85rem; opacity: 0.8; }

        /* Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
        .card.gold { background: linear-gradient(135deg, #fffbeb, #fef3c7); border-color: #fcd34d; grid-column: 1 / -1; }
        body.dark-mode .card.gold { background: linear-gradient(135deg, #451a03, #78350f); border-color: #92400e; }
        .card.gold .amount { color: #b45309; }
        body.dark-mode .card.gold .amount { color: #fbbf24; }

        .border-l-green { border-right: 5px solid var(--success); }
        .border-l-red { border-right: 5px solid var(--danger); }
        .border-l-blue { border-right: 5px solid var(--primary); }
        .border-l-gold { border-right: 5px solid var(--gold); }

        /* Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ */
        .input-group {
            background: var(--card-bg);
            padding: 25px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
            align-items: end;
        }

        .form-control label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; color: var(--text-muted); }
        .form-control input, .form-control select {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--bg);
            color: var(--text-main);
            font-family: inherit;
            box-sizing: border-box;
            outline: none;
            transition: border-color 0.2s;
        }
        .form-control input:focus, .form-control select:focus { border-color: var(--primary); }

        .action-btn {
            padding: 12px 25px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
            height: 45px;
            transition: background 0.2s;
        }
        .action-btn:hover { filter: brightness(110%); }

        /* Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
        .table-container {
            background: var(--card-bg);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            overflow-x: auto;
        }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { text-align: right; padding: 16px; background: var(--bg); color: var(--text-muted); font-size: 0.9rem; }
        td { padding: 16px; border-bottom: 1px solid var(--border); color: var(--text-main); }
        tr:last-child td { border-bottom: none; }
        
        .delete-btn {
            background: #fee2e2; color: #dc2626; border: none; width: 32px; height: 32px;
            border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .delete-btn:hover { background: #fecaca; }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø³ÙÙ„ÙŠØ© */
        .data-controls { margin-top: 30px; padding-top: 20px; border-top: 1px solid #334155; }
        .control-btn {
            display: block; width: 100%; padding: 10px; margin-bottom: 10px;
            background: #334155; color: #cbd5e1; border: none; border-radius: 8px;
            cursor: pointer; font-family: inherit; transition: 0.2s; text-align: right; padding-right: 15px;
        }
        .control-btn:hover { background: #475569; color: white; }
        
        /* Ø´Ø±ÙŠØ· Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© */
        .budget-bar-bg { height: 10px; background: var(--border); border-radius: 5px; margin-top: 10px; overflow: hidden; }
        .budget-bar-fill { height: 100%; background: var(--success); width: 0%; transition: width 0.5s; }

        @media (max-width: 900px) {
            .sidebar { width: 70px; padding: 15px 10px; }
            .sidebar h2, .nav-btn span, .data-controls span { display: none; }
            .nav-btn { justify-content: center; padding: 15px 0; }
            .main-content { margin-right: 70px; padding: 20px; width: calc(100% - 70px); }
            .control-btn { text-align: center; padding: 10px 0; }
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>Ø¹Ù…Ø± ğŸ“Š</h2>
        <button class="nav-btn active" onclick="showPage('home')"><span>ğŸ </span> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        <button class="nav-btn" onclick="showPage('transfer')"><span>ğŸ”€</span> Ø§Ù„ØªØ­ÙˆÙŠÙ„Ø§Øª</button>
        <button class="nav-btn" onclick="showPage('meeza')"><span>ğŸ’³</span> Ù…ÙŠØ²Ø©</button>
        <button class="nav-btn" onclick="showPage('fawry')"><span>âš¡</span> ÙÙˆØ±ÙŠ</button>
        <button class="nav-btn" onclick="showPage('personal')"><span>ğŸ“</span> Ù…ØµØ§Ø±ÙŠÙ</button>
        <button class="nav-btn" onclick="showPage('income')"><span>ğŸ’°</span> Ø§Ù„Ø¯Ø®Ù„</button>
        <button class="nav-btn" onclick="showPage('debts')"><span>ğŸ“‰</span> Ø¯ÙŠÙˆÙ†</button>
        <button class="nav-btn" onclick="showPage('credits')"><span>ğŸ“ˆ</span> Ø¯Ø§ÙŠÙ†</button>
        <button class="nav-btn" onclick="showPage('settings')"><span>âš™ï¸</span> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>

        <div class="data-controls">
            <button class="control-btn" onclick="toggleDarkMode()">ğŸŒ— Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ</button>
            <button class="control-btn" onclick="exportData()">ğŸ’¾ Ø­ÙØ¸ Ù†Ø³Ø®Ø©</button>
            <button class="control-btn" onclick="importData()">ğŸ“‚ Ø§Ø³ØªØ±Ø¬Ø§Ø¹</button>
            <button class="control-btn" style="color:#ef4444" onclick="resetData()">âš  ØªØµÙÙŠØ±</button>
        </div>
    </div>

    <div class="main-content">

        <div id="home" class="page active">
            <h1>Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ Ø¹Ù…Ø± ğŸ‘‹</h1>
            <div class="dashboard-grid">
                <div class="card gold">
                    <h3>ğŸ’ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø«Ø±ÙˆØªÙƒ (ÙƒÙ„ Ù…Ø§ ØªÙ…Ù„Ùƒ)</h3>
                    <div class="amount" id="home-total-wealth">0 Ø¬.Ù…</div>
                </div>

                <div class="card border-l-green">
                    <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙƒÙ„ Ø§Ù„Ù„ÙŠ Ø¯Ø®Ù„ ğŸ“¥</h3>
                    <div class="amount" id="home-grand-in" style="color:var(--success)">0 Ø¬.Ù…</div>
                </div>

                <div class="card border-l-red">
                    <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙƒÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ğŸ“¤</h3>
                    <div class="amount" id="home-grand-out" style="color:var(--danger)">0 Ø¬.Ù…</div>
                </div>

                <div class="card border-l-blue">
                    <h3>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù…Ù† Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ø­Ø± ğŸ’°</h3>
                    <div class="amount" id="home-net-income" style="color:var(--primary)">0 Ø¬.Ù…</div>
                </div>

                <div class="card border-l-green">
                    <h3>ÙÙ„ÙˆØ³ Ù„ÙŠÙƒ (Ø§Ù„Ø¯Ø§ÙŠÙ†) ğŸ“ˆ</h3>
                    <div class="amount" id="home-credits-total" style="color:var(--success)">0 Ø¬.Ù…</div>
                </div>

                <div class="card border-l-red">
                    <h3>ÙÙ„ÙˆØ³ Ø¹Ù„ÙŠÙƒ (Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©) ğŸ“‰</h3>
                    <div class="amount" id="home-debts-total" style="color:var(--danger)">0 Ø¬.Ù…</div>
                </div>

                <div class="card"><h3>Ø±ØµÙŠØ¯ Ù…ÙŠØ²Ø© ğŸ’³</h3><div class="amount" id="home-meeza-balance">0</div></div>
                <div class="card"><h3>Ø±ØµÙŠØ¯ ÙÙˆØ±ÙŠ âš¡</h3><div class="amount" id="home-fawry-balance">0</div></div>
            </div>
        </div>

        <div id="settings" class="page">
            <h1>âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h1>
            <div class="input-group" style="display:block">
                <h3 style="margin-top:0">ğŸ·ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</h3>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <input type="text" id="new-cat-input" placeholder="Ø§Ø³Ù… Ø§Ù„ØªØµÙ†ÙŠÙ" style="padding: 10px; border-radius:8px; border:1px solid var(--border); background:var(--bg); color:var(--text-main);">
                    <button class="action-btn" onclick="addNewCategory()">Ø¥Ø¶Ø§ÙØ©</button>
                </div>
                <div id="categories-list" style="display: flex; gap: 10px; flex-wrap: wrap;"></div>
            </div>
        </div>

        <div id="transfer" class="page">
            <h1>ğŸ”€ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ù…ÙˆØ§Ù„</h1>
            <div class="input-group" style="background: rgba(37, 99, 235, 0.05); border-color: var(--primary);">
                <div class="form-control"><label>Ù…Ù† Ø­Ø³Ø§Ø¨</label><select id="transfer-from" onchange="updateTransferOptions()"><option value="cash">ğŸ’° Ø§Ù„ÙƒØ§Ø´ (Ø§Ù„Ø¯Ø®Ù„)</option><option value="meeza">ğŸ’³ Ù…ÙŠØ²Ø©</option></select></div>
                <div class="form-control"><label>Ø¥Ù„Ù‰ Ø­Ø³Ø§Ø¨</label><select id="transfer-to"></select></div>
                <div class="form-control"><label>Ø§Ù„Ù…Ø¨Ù„Øº</label><input type="number" id="transfer-amount"></div>
                <button class="action-btn" onclick="executeTransfer()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ­ÙˆÙŠÙ„</button>
            </div>
        </div>

        <div id="meeza" class="page">
            <h1>ğŸ’³ Ù…ÙŠØ²Ø©</h1>
            <div class="dashboard-grid"><div class="card"><h3>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ</h3><div class="amount" id="meeza-balance">0</div></div></div>
            <div class="input-group">
                <div class="form-control"><label>Ø§Ù„Ù†ÙˆØ¹</label><select id="meeza-type"><option value="in">Ø¥ÙŠØ¯Ø§Ø¹</option><option value="out">Ø³Ø­Ø¨</option></select></div>
                <div class="form-control"><label>Ø§Ù„Ù…Ø¨Ù„Øº</label><input type="number" id="meeza-amount"></div>
                <div class="form-control"><label>Ø§Ù„ØªØµÙ†ÙŠÙ</label><select id="meeza-cat" class="dynamic-cat"></select></div>
                <div class="form-control"><label>Ù…Ù„Ø§Ø­Ø¸Ø©</label><input type="text" id="meeza-note"></div>
                <button class="action-btn" onclick="addTransaction('meeza')">Ø­ÙØ¸</button>
            </div>
            <div class="table-container"><table><thead><tr><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th><th>Ø­Ø°Ù</th></tr></thead><tbody id="meeza-table"></tbody></table></div>
        </div>

        <div id="fawry" class="page">
            <h1>âš¡ ÙÙˆØ±ÙŠ</h1>
            <div class="dashboard-grid"><div class="card"><h3>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ</h3><div class="amount" id="fawry-balance">0</div></div></div>
            <div class="input-group">
                <div class="form-control"><label>Ø§Ù„Ù†ÙˆØ¹</label><select id="fawry-type"><option value="in">Ø´Ø­Ù†</option><option value="out">Ø¯ÙØ¹</option></select></div>
                <div class="form-control"><label>Ø§Ù„Ù…Ø¨Ù„Øº</label><input type="number" id="fawry-amount"></div>
                <div class="form-control"><label>Ø§Ù„ØªØµÙ†ÙŠÙ</label><select id="fawry-cat" class="dynamic-cat"></select></div>
                <div class="form-control"><label>Ù…Ù„Ø§Ø­Ø¸Ø©</label><input type="text" id="fawry-note"></div>
                <button class="action-btn" onclick="addTransaction('fawry')">Ø­ÙØ¸</button>
            </div>
            <div class="table-container"><table><thead><tr><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th><th>Ø­Ø°Ù</th></tr></thead><tbody id="fawry-table"></tbody></table></div>
        </div>

        <div id="personal" class="page">
            <h1>ğŸ“ Ù…ØµØ§Ø±ÙŠÙ Ø´Ø®ØµÙŠØ©</h1>
            <div class="card" style="margin-bottom:20px">
                <div style="display: flex; justify-content: space-between; align-items:center">
                    <h3>ğŸ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</h3>
                    <input type="number" id="budget-limit" placeholder="Ø­Ø¯Ø¯ Ø§Ù„Ù…Ø¨Ù„Øº" onchange="setBudget()" style="width:100px; padding:5px; border-radius:5px; border:1px solid #ccc">
                </div>
                <div class="budget-bar-bg"><div id="budget-bar" class="budget-bar-fill"></div></div>
                <small id="budget-text" style="display:block; margin-top:5px; text-align:left">0% Ù…Ø³ØªØ®Ø¯Ù…</small>
            </div>

            <div class="input-group">
                <div class="form-control"><label>Ø§Ù„Ù…Ø¨Ù„Øº</label><input type="number" id="personal-amount"></div>
                <div class="form-control"><label>Ø§Ù„ØªØµÙ†ÙŠÙ</label><select id="personal-cat" class="dynamic-cat"></select></div>
                <div class="form-control"><label>Ù…Ù„Ø§Ø­Ø¸Ø©</label><input type="text" id="personal-note"></div>
                <button class="action-btn" onclick="addTransaction('personal')">Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</button>
            </div>
            <div class="table-container"><table><thead><tr><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ØªØµÙ†ÙŠÙ - Ù…Ù„Ø§Ø­Ø¸Ø©</th><th>Ø­Ø°Ù</th></tr></thead><tbody id="personal-table"></tbody></table></div>
        </div>

        <div id="income" class="page">
            <h1>ğŸ’° Ø§Ù„Ø¯Ø®Ù„</h1>
            <div class="input-group">
                <div class="form-control"><label>Ø§Ù„Ù…Ø¨Ù„Øº</label><input type="number" id="income-amount"></div>
                <div class="form-control"><label>Ø§Ù„Ù…ØµØ¯Ø±</label><input type="text" id="income-note"></div>
                <button class="action-btn" onclick="addTransaction('income')">Ø¥Ø¶Ø§ÙØ© Ø¯Ø®Ù„</button>
            </div>
            <div class="table-container"><table><thead><tr><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…ØµØ¯Ø±</th><th>Ø­Ø°Ù</th></tr></thead><tbody id="income-table"></tbody></table></div>
        </div>

        <div id="debts" class="page">
            <h1>ğŸ“‰ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©</h1>
            <div class="input-group"><div class="form-control"><label>Ø§Ù„Ù…Ø¨Ù„Øº</label><input type="number" id="debts-amount"></div><div class="form-control"><label>Ø§Ù„Ø¯Ø§Ø¦Ù†</label><input type="text" id="debts-note"></div><button class="action-btn" onclick="addTransaction('debts')">ØªØ³Ø¬ÙŠÙ„</button></div>
            <div class="table-container"><table><thead><tr><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø¯Ø§Ø¦Ù†</th><th>Ø­Ø°Ù</th></tr></thead><tbody id="debts-table"></tbody></table></div>
        </div>

        <div id="credits" class="page">
            <h1>ğŸ“ˆ Ø§Ù„Ø¯Ø§ÙŠÙ†</h1>
            <div class="input-group"><div class="form-control"><label>Ø§Ù„Ù…Ø¨Ù„Øº</label><input type="number" id="credits-amount"></div><div class="form-control"><label>Ø§Ù„Ù…Ø¯ÙŠÙ†</label><input type="text" id="credits-note"></div><button class="action-btn" onclick="addTransaction('credits')">ØªØ³Ø¬ÙŠÙ„</button></div>
            <div class="table-container"><table><thead><tr><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…Ø¯ÙŠÙ†</th><th>Ø­Ø°Ù</th></tr></thead><tbody id="credits-table"></tbody></table></div>
        </div>

    </div>

    <script>
        let appData = { meeza: [], fawry: [], personal: [], income: [], debts: [], credits: [] };
        let settings = { 
            budget: 0, 
            darkMode: false,
            categories: ['Ø·Ø¹Ø§Ù… ğŸ”', 'Ù…ÙˆØ§ØµÙ„Ø§Øª ğŸšŒ', 'ÙÙˆØ§ØªÙŠØ± ğŸ“±', 'Ø¬Ø§Ù…Ø¹Ø© ğŸ“š', 'ØªØ­ÙˆÙŠÙ„Ø§Øª ğŸ”€', 'Ø£Ø®Ø±Ù‰'] 
        };

        window.onload = function() {
            if(localStorage.getItem('omarFinancePro')) {
                // Ø¯Ù…Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… ÙÙ‚Ø¯Ø§Ù† Ø£ÙŠ Ø´ÙŠØ¡
                let saved = JSON.parse(localStorage.getItem('omarFinancePro'));
                appData = { ...appData, ...saved };
            }
            if(localStorage.getItem('omarSettings')) {
                settings = { ...settings, ...JSON.parse(localStorage.getItem('omarSettings')) };
            }

            if(settings.darkMode) document.body.classList.add('dark-mode');
            document.getElementById('budget-limit').value = settings.budget;

            populateCategories();
            updateTransferOptions();
            updateAllViews();
        };

        // --- Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª ---
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø± ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
            let activeBtn = Array.from(document.querySelectorAll('.nav-btn')).find(btn => btn.getAttribute('onclick').includes(pageId));
            if(activeBtn) activeBtn.classList.add('active');
            
            updateAllViews();
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            settings.darkMode = document.body.classList.contains('dark-mode');
            saveSettings();
        }

        function saveSettings() { localStorage.setItem('omarSettings', JSON.stringify(settings)); }
        function saveData() { localStorage.setItem('omarFinancePro', JSON.stringify(appData)); }

        // --- Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª ---
        function populateCategories() {
            document.querySelectorAll('.dynamic-cat').forEach(select => {
                select.innerHTML = '';
                settings.categories.forEach(cat => {
                    let option = document.createElement('option');
                    option.value = cat; option.text = cat;
                    select.appendChild(option);
                });
            });
            let listDiv = document.getElementById('categories-list');
            listDiv.innerHTML = '';
            settings.categories.forEach(cat => {
                let tag = document.createElement('span');
                tag.style.cssText = "background:var(--primary); color:white; padding:5px 10px; border-radius:15px; font-size:0.9rem; margin-bottom:5px;";
                tag.innerHTML = `${cat} <span style="cursor:pointer; margin-right:5px; opacity:0.7" onclick="removeCategory('${cat}')">Ã—</span>`;
                listDiv.appendChild(tag);
            });
        }

        function addNewCategory() {
            let val = document.getElementById('new-cat-input').value.trim();
            if(val && !settings.categories.includes(val)) {
                settings.categories.push(val);
                saveSettings(); populateCategories();
                document.getElementById('new-cat-input').value = '';
            }
        }

        function removeCategory(cat) {
            if(confirm('Ø­Ø°Ù Ø§Ù„ØªØµÙ†ÙŠÙØŸ')) {
                settings.categories = settings.categories.filter(c => c !== cat);
                saveSettings(); populateCategories();
            }
        }

        // --- Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª ---
        function addTransaction(cat, manualData = null) {
            let amount, desc, type, date = new Date().toLocaleDateString('ar-EG');
            if(manualData) {
                amount = manualData.amount; desc = manualData.desc; type = manualData.type;
            } else {
                let amtInput = document.getElementById(`${cat}-amount`);
                let noteInput = document.getElementById(`${cat}-note`) || document.getElementById(`${cat}-desc`);
                let catInput = document.getElementById(`${cat}-cat`);
                let typeInput = document.getElementById(`${cat}-type`);

                amount = parseFloat(amtInput.value);
                let note = noteInput ? noteInput.value : '';
                let category = catInput ? catInput.value : '';
                desc = category ? `${category} - ${note}` : note;
                type = typeInput ? typeInput.value : 'single';

                if (isNaN(amount) || amount <= 0) { alert('Ø§Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­'); return; }
                amtInput.value = ''; if(noteInput) noteInput.value = '';
            }
            appData[cat].push({ id: Date.now(), amount, desc, type, date });
            saveData(); updateAllViews();
        }

        function deleteTransaction(cat, id) {
            if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ')) {
                appData[cat] = appData[cat].filter(item => item.id !== id);
                saveData(); updateAllViews();
            }
        }

        // --- Ø§Ù„ØªØ­ÙˆÙŠÙ„Ø§Øª ---
        function updateTransferOptions() {
            let from = document.getElementById('transfer-from').value;
            let to = document.getElementById('transfer-to');
            to.innerHTML = '';
            if(from === 'cash') to.innerHTML += '<option value="meeza">ğŸ’³ Ù…ÙŠØ²Ø©</option>';
            else if(from === 'meeza') to.innerHTML += '<option value="fawry">âš¡ ÙÙˆØ±ÙŠ</option>';
        }

        function executeTransfer() {
            let from = document.getElementById('transfer-from').value;
            let to = document.getElementById('transfer-to').value;
            let amount = parseFloat(document.getElementById('transfer-amount').value);
            if(isNaN(amount) || amount <= 0) return;

            if(from === 'cash') addTransaction('personal', { amount, desc: `ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ ${to}`, type: 'single' });
            else if (from === 'meeza') addTransaction('meeza', { amount, desc: `ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ ${to}`, type: 'out' });

            if(to === 'meeza') addTransaction('meeza', { amount, desc: `ØªØ­ÙˆÙŠÙ„ Ù…Ù† ${from}`, type: 'in' });
            else if (to === 'fawry') addTransaction('fawry', { amount, desc: `ØªØ­ÙˆÙŠÙ„ Ù…Ù† ${from}`, type: 'in' });

            document.getElementById('transfer-amount').value = '';
            alert('ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­ âœ…');
        }

        // --- Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙˆØ§Ù„Ø¹Ø±Ø¶ ---
        function updateAllViews() {
            ['meeza', 'fawry', 'personal', 'income', 'debts', 'credits'].forEach(cat => updateCatView(cat));
            updateSummary();
        }

        function updateCatView(cat) {
            let tbody = document.getElementById(`${cat}-table`);
            if(!tbody) return;
            tbody.innerHTML = '';
            let totalIn = 0, totalOut = 0;
            [...appData[cat]].reverse().forEach(item => {
                if(item.type === 'in') totalIn += item.amount; else if(item.type === 'out') totalOut += item.amount;
                let colorClass = item.type === 'in' ? 'color:var(--success)' : (item.type === 'out' ? 'color:var(--danger)' : '');
                let sign = item.type === 'in' ? '+' : (item.type === 'out' ? '-' : '');
                
                tbody.innerHTML += `<tr>
                    <td style="font-weight:bold; ${colorClass}">${sign}${item.amount.toLocaleString()}</td>
                    <td style="font-size:0.85rem; color:var(--text-muted)">${item.date}</td>
                    <td>${item.desc}</td>
                    <td><button class="delete-btn" onclick="deleteTransaction('${cat}', ${item.id})">ğŸ—‘</button></td>
                </tr>`;
            });
            let balance = totalIn - totalOut;
            if(document.getElementById(`${cat}-balance`)) document.getElementById(`${cat}-balance`).innerText = balance.toLocaleString() + " Ø¬.Ù…";
        }

        function updateSummary() {
            let meezaBal = sum(appData.meeza, 'in') - sum(appData.meeza, 'out');
            let fawryBal = sum(appData.fawry, 'in') - sum(appData.fawry, 'out');
            let income = appData.income.reduce((a,b)=>a+b.amount,0);
            let personal = appData.personal.reduce((a,b)=>a+b.amount,0);
            let credits = appData.credits.reduce((a,b)=>a+b.amount,0);
            let debts = appData.debts.reduce((a,b)=>a+b.amount,0);
            let netIncome = income - personal;

            let grandIn = income + sum(appData.meeza, 'in') + sum(appData.fawry, 'in');
            let grandOut = personal + sum(appData.meeza, 'out') + sum(appData.fawry, 'out');
            let wealth = meezaBal + fawryBal + credits + netIncome;

            setTxt('home-total-wealth', wealth);
            setTxt('home-grand-in', grandIn);
            setTxt('home-grand-out', grandOut);
            setTxt('home-net-income', netIncome);
            setTxt('home-credits-total', credits);
            setTxt('home-debts-total', debts);
            setTxt('home-meeza-balance', meezaBal);
            setTxt('home-fawry-balance', fawryBal);

            // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©
            if(settings.budget > 0) {
                let percent = (personal / settings.budget) * 100;
                let bar = document.getElementById('budget-bar');
                let txt = document.getElementById('budget-text');
                
                bar.style.width = Math.min(percent, 100) + '%';
                txt.innerText = `${Math.round(percent)}% Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© (${personal}/${settings.budget})`;
                
                if(percent > 100) { bar.style.backgroundColor = 'var(--danger)'; txt.style.color = 'var(--danger)'; }
                else if(percent > 80) { bar.style.backgroundColor = 'var(--warning)'; }
                else { bar.style.backgroundColor = 'var(--success)'; }
            }
        }

        function setBudget() {
            settings.budget = parseFloat(document.getElementById('budget-limit').value);
            saveSettings(); updateAllViews();
        }

        function sum(arr, type) { return arr.filter(i => i.type === type).reduce((a, b) => a + b.amount, 0); }
        function setTxt(id, val) { if(document.getElementById(id)) document.getElementById(id).innerText = val.toLocaleString() + " Ø¬.Ù…"; }
        
        // --- Ø§Ù„ØªØµØ¯ÙŠØ± ÙˆØ§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ø·ÙˆØ± (Ø§Ù„Ø¥ØµÙ„Ø§Ø­) ---
        function exportData() {
            let dataStr = JSON.stringify({ data: appData, settings: settings });
            let link = document.createElement('a');
            link.href = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
            link.download = `omar_backup_${new Date().toISOString().slice(0,10)}.json`;
            link.click();
        }

        function importData() {
            let input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = e => {
                let file = e.target.files[0];
                if (!file) return;
                let reader = new FileReader();
                reader.onload = ev => {
                    try {
                        let content = JSON.parse(ev.target.result);
                        // Ø¯Ø¹Ù… Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙˆØ§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                        if (content.data && content.settings) {
                            appData = content.data;
                            settings = content.settings;
                        } else {
                            // Ø§ÙØªØ±Ø§Ø¶ Ø£Ù†Ù‡Ø§ Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¯ÙŠÙ…Ø©
                            appData = content;
                        }
                        
                        saveData();
                        saveSettings();
                        alert('ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­! Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.');
                        location.reload();
                    } catch (err) {
                        alert('Ø­Ø¯Ø« Ø®Ø·Ø£! Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­.');
                        console.error(err);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function resetData() {
            if(confirm('âš ï¸ ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) {
                localStorage.clear();
                location.reload();
            }
        }
    </script>
</body>
</html>
